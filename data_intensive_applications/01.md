# 01장 신뢰할 수 있고 확장 가능하며 유지보수하기 쉬운 애플리케이션

## 신뢰성

하드웨어나 소프트웨어 심지어 인적오류가 발생하더라도 시스템은 지속적으로 올바르게 동작해야 한다.

무언가 잘못되더라도 지속적으로 올바르게 동작함

- fault (결함) : 잘못될 수 있는 일
- fault-tolerant(내결함성) or resilient(탄력성) : 결함을 예측하고 대처할 수 있는 시스템
- 결함 != 장애
- 장애 : 사용자에게 서비스를 제공하지 못하고 서비스 시스템 전체가 멈춘 경우
- 결함이 발생할 확률을 0으로 줄이는 것은 불가능 따라서 fault tolerant하게 시스템을 설계하는 것이 가장 좋다.
- 고의적으로 결함을 유도하여 시스템의 resilient를 지속적으로 훈련하고 테스트하여 결함 발생 시 처리할 수 있다는 자신감을 높인 사례 -> 넷플릭스의 카오스 몽키



### 하드웨어 결함

- 소프트웨어 내결함성 기술을 사용하거나 하드웨어 중복성을 추가해 전체 장비의 손실을 견딜 수 있는 시스템으로 옮겨가고 있는 추세
- 이렇게 운영하는 시스템은 장비 재부팅 등의 경우에도 시스템 중단 없이 운영할 수 있다는 장점이 있다.

### 소프트웨어 오류

- 빠른 해결책이 없다.
- 테스트, 프로세스 격리, 셀프 힐링 등이 문제 해결에 도움을 줄 수 있다.

### 인적 오류

- 하드웨어 결함은 중단 원인의 10 ~ 25%에 그치는 반면 운영자의 설정 오류는 중단의 주요 원인
- 오류의 가능성을 최소화 하는 방향으로 시스템을 설계
- 샌드박스 운영
- 철저한 테스트
- 롤백 제공
- 모니터링



## 확장성

시스템의 데이터 양, 트래픽 양, 복잡도가 증가하면서 이를 처리할 수 있는 적절한 방법이 있어야 한다. 시스템이 현재 안정적이라고 해서 미래에도 안정적일 것이라는 보장은 없다. 

"X는 확장 가능하다 or 확장 불가능하다"라는 말은 의미가 없다. 확장성을 논한다는 것은 "시스템이 특정 방식으로 커지면 이에 대응하기 위한 방법은 무엇인가?" 혹은 "추가 부하를 다루기 위해 컴퓨팅 리소스는 어떻게 투입해야 할까?" 와 같은 질문을 고려한다는 의미다.

### 부하 기술하기

부하 성장 질문(부하가 두 배로 되면 어떻게 될까?)을 논의하려면 시스템의 현재 부하를 간결하게 기술할 수 있어야 한다. 부하는 load parameter(부하 매개변수)라고 불리는 몇 개의 숫자로 나타낼 수 있다.

시스템 마다 적합한 load parameter는 달라질 수 있다. load parameter 예로 웹 서버의 초당 요청 수, 데이터베이스의 읽기 대 쓰기 비율, 대화방의 active user, 캐시 적중률 등이 있다. 평균적인 수치가 중요할 수도 있고, 소스의 극단적인 경우가 병목 현상의 원인일 수도 있다.

### 성능 기술하기

시스템 부하를 기술하면 부하 증가시 어떤 일이 발생할 수 있는지 알아볼 수 있다. 다음 두가지 방법으로 살펴 볼 수 있다.

- 부하 매개변수를 증가시키고, 시스템 자원은 유지하면 시스템 성능엔 어떤 영향이 갈까?
- 부하 매개변수를 증가시켰을 때 성능을 유지하려면 자원을 얼마나 늘려야 할까?



두 질문 모두 성능 수치가 필요하다. 시스템 성능에 대해 간단히 살펴보자.



하둡과 같은 일괄 처리 시스템은 보통 처리량(throughput)에 관심을 가지는 반면 온라인 시스템에서는 서비스 응답 시간(response time) 즉 클라이언트가 요청을 보내고 응답을 받는 사이의 시간에 더 관심을 갖는다.

클라이언트가 요청을 보내고 받을 때 마다 응답시간은 달라진다. 따라서 응답 시간은 단일 숫자가 아니라 측정 가능한 값의 분포로 생각해야 한다.

사용자가 보통 얼마나 오랫동안 기다려야 하는지 알고 싶다면 중앙값이 좋은 지표다. 사용자 요청의 절반은 중앙값 응답 시간 미만으로 제공되고, 나머지 반은 중앙값보다 오래 걸린다. 중앙값은 50분위로서 p50으로 축약할 수 있다.

특이 값이 얼마나 좋지 않은지를 확인하려면 상위 백분위(일반적으로  p95, p99, p100)를 살펴보는 것도 좋다.

꼬리 지연 시간(tail latency)로 알려진 상위 백분위 응답 시간은 서비스 사용자 경험에 직접적인 영향을 주기 때문에 중요하다.

백분위는 SLO(Service Level Objective, 서비스 수준 목표)와 SLA(Service Level Agreement, 서비스 수준 협약서)에 자주 사용하고 기대 성능과 서비스 가용성을 정의하는 계약서에도 자주 등장한다. 



### 부하 대응 접근 방식

- 용량 확장(Scaling Up), 수직 확장(Vertical Scaling)
- 규모 확장(Scale out), 수평 확장(Horizontal Scaling)

다수의 장비에 부하를 분산하는 아키텍처를 비공유(shared-noting) 아키텍처라고 부른다.

일부 시스템은 탄력적(elastic)이다. 부하를 감지하면 컴퓨팅 자원이 자동으로 추가된다. 그렇지 못한 시스템은 사람이 수동으로 확장해야한다. 탄력적인 시스템은 부하가 예측 불가능한 수준으로 높을 경우 유용하고, 수동으로 확장하는 시스템은 더 간단하고 예측 불가능한 일이 더 적다.

stateless 서비스를 여러 장비에 배포하는 일은 간단하지만, stateful 서비스를 분산 설치하는 일은 복잡도가 높다. 이러한 이유로 확장 비용이나 데이터베이스를 분산해야하는 요구가 있을 때까지는 단일 노드로 운영하는 것이 최근까지의 통념이었다. 하지만 분산 시스템을 위한 도구와 추상화가 발전하여 이 통념이 일부 애플리케이션에서는 바뀌었다. 향후에는 대용량 데이터와 트래픽을 다루지 않는 사례에서도 분산 데이터 시스템이 기본 아키텍처로 자리 잡을 확률이 높다.

대규모로 동작하는 시스템의 아키텍처는 해당 시스템을 사용하는 애플리케이션에 특화 되어 있어 범용적이고 모든 상황에서 사용할 수 있는 (one-size-fits-all) 확장 아키텍처 (magic scaling source)는 없다. 

특정 애플리케이션에 적합한 확장성을 갖춘 아키텍처는 주요 동작이 무엇이고 잘 사용하지 않는 동작이 무엇인지에 대한 가정을 바탕으로 만들어진다. 이 가정은 곧 부하 매개변수가 된다. 이 가정이 잘못되면 엔지니어링은 최악의 경우 역효과를 낳는다. 스타트업 초기나 검증되지 않은 제품을 만들 때에는 미래의 부하에 가정해서 확장하기 보다는 빠르게 반복해서 제품 기능을 개선하는 것이 더 중요하다.