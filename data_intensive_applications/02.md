# 2장 데이터 모델과 질의 언어

데이터 모델은 소프트웨어가 어떻게 작성됐는지 뿐만 아니라 해결하려는 문제를 어떻게 생각해야 하는지에 대해서도 지대한 영향을 미치기 때문에 소프트웨어 개발에서 제일 중요한 부분이다.

## 관계형 모델과 문서 모델

오늘날 가장 잘 알려진 데이터 모델은 1970년 Edgar Codd가 제안한 관계형 모델을 기반으로 한 SQL이다. 데이터(SQL에서는 테이블)는 Relation(관계)으로 구성되고 관계는 순서 없는 Tuple(튜플, SQL에서는 row) 모임이다.

1970년대와 1980년대 초반에는 네트워크 모델과 계층 모델이 주요 대안이었지만 결국 관계형 모델이 우위를 차지했다.

### NoSQL의 탄생

Not Only SQL

2010년대에 NoSQL은 관계형 모델의 우위를 뒤집으려는 가장 최근의 시도이다.

NoSQL 데이터베이스 채택 원동력

- 대규모 데이터셋이나 매우 높은 쓰기 처리량을 관계형 데이터베이스보다 쉽게 달성할 수 있는 높은 확장성의 필요
- 무료 오픈소스 소프트웨어 선호도의 확산
- 관계형 모델에서 지원하지 않는 특수 질의 동작
- 관계형 스키마의 제한에 대한 불만과 더욱 동적이고 표현력이 풍부한 데이터 모델에 대한 바람

애플리케이션은 저마다 요구사항이 달라 최적의 선택이 각각 다를 수 있어 미래에는 관계형 데이터베이스가 비관계형 데이터스토어와 함께 사용될 것이다. 이런 개념을 종종 다중 저장소 지속성(polyglot persistence)라고 한다.

### 객체 관계형 불일치

- Impedence Mismatch: 데이터를 관계형 테이블에 저장하기 위해 애플리케이션 코드와 데이터 베이스 모델 객체 사이에서 필요한 전환 계층의 분리
- 하이버네이트와 같은 ORM 도구를 사용하면 전환 계층에 필요한 boilerplate code를 줄일 수는 있지만 두 모델 간의 차이를 완전히 없앨 수는 없다.

### 다대일과 다대다 관계

- 중복된 데이터를 정규화하기 위해서는 다대일(many to one)관계가 필요한다, 문서 모델에는 이 관계가 적합하지 않다.
- 데이터베이스 자체가 조인을 지원하지 않으면 데이터베이스에 대한 다중 질의를 만들어서 애플리케이션 코드에서 조인을 흉내 내야 한다.

### 문서 데이터베이스는 역사를 반복하고 있나?

- 1970년대 비즈니스 데이터 처리를 위해 가장 많이 사용한 데이터베이스 IBM의 IMS
- IMS는 계층 모델이라 부르는 간단한 데이터 모델을 사용했고, 문서 데이터베이스의 JSON 모델과 비슷하다.
- 문서 데이터베이스 처럼 일대다 관계에서는 잘 동작하지만, 다대다 관계 표현은 어려웠고 조인을 지원하지 않아 결국 개발자가 수동으로 레코드간의 참조를 결정해야 했다. 이는 오늘날 문서 데이터베이스를 사용해서 작업 중인 개발자가 해결해야하는 문제와 매우 비슷하다.
- 이 계층모델의 한계를 해결하기 위해 관계형 모델과 네트워크 모델이 제안됐고, 이 두 모델간 논쟁은 1970년대 대부분 동안 지속 됐다. 그리고 이 논쟁은 오늘날의 문제와도 관련이 많아 현재 관점으로 간략히 다시 살펴보겠다.

#### 네트워크 모델

- AKA 코다실 모델
- 계층 모델의 트리 구조에서 모든 레코드는 정확하게 하나의 부모가 있는 반면, 네트워크 모델에서는 다중 부모가 있을 수 있다.
- 네트워크 모델에서 레코드에 접근하는 유일한 방법은 최상위 레코드(root record)에서 부터 연속된 연결 경로를 따르는 방법이다. 이를 접근 경로라고 한다.
- 코다실에서 만약 레코드가 다중 부모를 가진다면 애플리케이션 코드는 다양한 관계를 모두 추적해야 한다. 코다실 위원회도 이 방식이 n차원 데이터 공간을 향해 가는 것과 같다고 인정했다.
- 수동 접근 경로 선택은 1970년대에는 제한된 하드웨어 성능을 효율적으로 사용할 수 있었지만 데이터베이스 질의와 갱신을 위한 코드가 복잡하고 유연하지 못하다는 문제가 있었다. 계층모델과 네트워크 모델 모두 원하는 데이터에 대한 경로가 없을 때 어려운 상황에 놓인다.

#### 관계형 모델

- 얽히고설킨 중컵 구조와 데이터를 보고 싶을 때 따라가야 할 복잡한 접근 경로가 없다. 
- 관계형 데이터베이스에서 Query Optimizer는 질의의 어느 부분을 어떤 순서로 실행할지를 결정하고 사용할 색인을 자동으로 결정한다. 이 선택은 실제로 "접근 경로"다. 하지만 애플리케이션 개발자가 아니라 Query Optimizer가 이 경로를 자동으로 만든다는 점이 큰 차이점이다.
- 새로운 방식으로 데이터를 질의하고 싶은 경우 새로운 색인을 선언하기만 하면 질의는 자동으로 가장 적합한 색인을 사용하게 된다. 새로운 색인을 사용하기 위해 질의를 바꿀 필요가 없다. 따라서 관계형 모델은 애플리케이션에 새로운 기능을 추가하는 작업이 훨씬 쉽다.
- 관계형 데이터베이스를 위한 질의 최적화기를 만들기 위해서는 수년간의 연구와 개발 노력이 필요하다. 하지만, 이를 한번 만들면 데이터베이스를 사용하는 모든 애플리케이션이 혜택을 받을 수 있다.

#### 문서 데이터베이스와의 비교

- 별도 테이블이 아닌 상위 레코드 내에 중첩된 레코드를 저장한다는 점에서 계층 모델로 돌아갔다.
- 다대일과 다대다 관계를 표현할 때 관계형 데이터베이스와 문서 데이터베이스는 근본적으로 다르지 않다. 둘 다 관련 항목은 고유한 식별자로 참조한다. 관계형 모델에서는 이를 외래키라 부르고 문서 모델에서는 문서 참조(document reference)라 부른다.

### 관계형 데이터베이스와 오늘날의 문서 데이터베이스

- 문서 데이터 모델을 선호하는 주요 이유는 스키마 유연성, 지역성에 기인한 더 나은 성능 때문이고 일부 애플리케이션의 경우 애플리케이션에서 사용하는 데이터 구조와 더 가깝다.
- 관계형 데이터 모델은 조인, 다대일, 다대다 관계를 더 잘 지원함으로써 문서 데이터 모델에 대항한다.

#### 어떤 데이터 모델이 애플리케이션 코드를 더 간단하게 할까?

- 데이터가 문서와 같은 구조라면 문서 모델을 사용하는 것이 좋다. 관계형 기법은 문서와 비슷한 구조를 여러 테이블로 나누어 찢어 (shredding) 스키마와 애플리케이션의 복잡도를 증가시킨다.
- 문서 모델에는 제한이 있다.
  - 문서 내 중첩 항목을 바로 표시하는 것이 불가능하여 '사용자 251의 직위 목록의 두 번째 항목'과 같은 식으로 나타내야 한다. 문서가 너무 깊게 중첩되는 것이 아니라면 문제가 되지 않는다.
- 문서 모델은 조인 지원이 미흡하다.
  - 애플리케이션에 따라 문제일 수도 있고 아닐 수도 있다.
- 다대다 관계를 사용하는 애플리케이션에서 문서 모델은 매력이 떨어진다.
  - 비정규화를 통해 조인을 줄일 수 있지만, 비정규화된 데이터의 일관성을 위한 추가 작업이 필요하다.
  - 애플리케이션 코드에서 조인을 흉내낼 경우 복잡도가 애플리케이션으로 이동할 뿐만 아니라, 보통 데이터베이스 내 특화된 코드로 수행되는 조인보다 더 느리다.
- 어떤 데이터 모델이 애플리케이션 코드를 더 간단하게 만드는지는 말할 수 없다. 데이터 항목 간에 존재하는 관계 유형에 따라 다르다. 상호 연결이 많은 데이터의 경우 문서 모델은 곤란하지만 관계형 모델은 무난하며 그래프 모델은 매우 자연스럽다.